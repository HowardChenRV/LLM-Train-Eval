# 集群基础性能评测

## 设备支持

- nvidia 全系列

- metax c500/c550

- huawei 910B

    华为暂未集成带宽测试和p2p测试，可以通过官方工具 [ascend-dmi](https://www.hiascend.com/document/detail/zh/mindx-dl/600/toolbox/ascenddmi/toolboxug_0010.html) 测试。

- ali ppu

## 运行方式

### 前置操作

- 1. 编译C共享库

```bash
cd sys_eval/csrc && make build
```

- 2. 安装打印结果依赖项

```bash
pip install tabulate
```

### 单机执行

```bash
export PYTHONPATH=${path-to-Infini-Eval}:$PYTHONPATH
torchrun --nproc_per_node 8 --nnodes 1 --node_rank 0 --master_addr localhost --master_port 6000 sys_common_bench.py
```

### 云平台执行

```bash
export GPUS_PER_NODE=8
export BASE_PATH=/mnt/public  # parent path of Infini-Eval
bash ${path-to-Infini-Eval}/examples/base_eval/run_nvidia_dist.sh
```

测试结果将汇总到rank0机器上打印。

## 评测项

### GEMM

用于测试加速卡算力，测试完成后结果汇总至rank0，测试结果示例如下：

Results: (TFLOPS)
|    |   16384x8192x1280-bf16 |   16384x8192x1280-fp16 |   16384x1024x8192-bf16 |   16384x1024x8192-fp16 |   8192x8192x8192-bf16 |   8192x8192x8192-fp16 |
|----|------------------------|------------------------|------------------------|------------------------|-----------------------|-----------------------|
|  0 |                159.441 |                159.715 |                159.603 |                161.874 |               162.162 |               153.541 |
|  1 |                159.76  |                159.373 |                159.432 |                161.669 |               161.579 |               154.061 |
|  2 |                158.8   |                158.65  |                158.622 |                160.846 |               160.694 |               153.897 |
|  3 |                159.464 |                159.162 |                159.271 |                161.62  |               161.574 |               154.052 |
|  4 |                158.298 |                157.873 |                158.136 |                160.289 |               160.454 |               153.679 |
|  5 |                159.011 |                158.665 |                158.838 |                161.038 |               159.885 |               153.184 |
|  6 |                158.83  |                158.209 |                158.285 |                160.567 |               160.27  |               154.048 |
|  7 |                159.267 |                158.051 |                159.346 |                161.543 |               161.482 |               153.961 |

### MEMCPY

用于测试加速卡显存带宽，以及D2H、H2D带宽。测试结果示例如下：

Results: (GB/s)
|    |   d2h-128MB |   h2d-128MB |   d2d-128MB |   d2h-512MB |   h2d-512MB |   d2d-512MB |   d2h-1024MB |   h2d-1024MB |   d2d-1024MB |
|----|-------------|-------------|-------------|-------------|-------------|-------------|--------------|--------------|--------------|
|  0 |     16.2377 |     25.1712 |     916.587 |     20.7874 |     25.1756 |     915.889 |      17.4338 |      25.1738 |      917.109 |
|  1 |     19.6066 |     25.0568 |     916.908 |     25.714  |     25.0621 |     914.828 |      17.8278 |      25.0591 |      915.707 |
|  2 |     22.5078 |     25.1252 |     916.908 |     23.5007 |     25.1402 |     915.227 |      21.9362 |      25.142  |      916.587 |
|  3 |     19.2796 |     24.9765 |     915.627 |     20.9075 |     24.9924 |     914.429 |      17.5812 |      24.9917 |      915.787 |
|  4 |     17.2756 |     25.1106 |     915.627 |     19.0795 |     25.1225 |     915.232 |      16.6317 |      25.1209 |      916.147 |
|  5 |     25.8049 |     25.1039 |     915.937 |     25.2968 |     25.1246 |     914.429 |      25.1863 |      25.1168 |      916.187 |
|  6 |     22.4893 |     25.1057 |     916.587 |     19.477  |     25.1152 |     914.828 |      16.989  |      25.1191 |      915.947 |
|  7 |     20.592  |     25.212  |     916.197 |     24.4666 |     25.2205 |     915.068 |      24.2064 |      25.2166 |      916.788 |

### P2P

用于测试同一节点内加速卡间P2P通信带宽和延迟。测试结果示例如下：

Results:
Unidirectional Bandwidth Matrix (GB/s): size=32MB
|    |    gpu:0 |    gpu:1 |    gpu:2 |    gpu:3 |    gpu:4 |    gpu:5 |    gpu:6 |    gpu:7 |
|----|----------|----------|----------|----------|----------|----------|----------|----------|
|  0 | 917.657  |  21.4196 |  21.4463 |  21.3058 |  21.5002 |  21.3497 |  21.3057 |  21.4534 |
|  1 |  21.4675 | 939.584  |  21.4886 |  21.4617 |  21.498  |  21.3893 |  21.3997 |  21.3208 |
|  2 |  21.4969 |  21.4922 | 936.229  |  21.3559 |  21.4545 |  21.3439 |  21.4932 |  21.4265 |
|  3 |  21.5205 |  21.4234 |  21.4734 | 939.584  |  21.4189 |  21.3301 |  21.416  |  21.3709 |
|  4 |  21.3939 |  21.3567 |  21.5157 |  21.4674 | 939.584  |  21.5676 |  21.5676 |  21.5901 |
|  5 |  21.403  |  21.4842 |  21.4557 |  21.4404 |  21.6591 | 938.463  |  21.5854 |  21.6055 |
|  6 |  21.3231 |  21.4908 |  21.4815 |  21.4359 |  21.6198 |  21.6103 | 939.935  |  21.5925 |
|  7 |  21.4387 |  21.3962 |  21.4616 |  21.4282 |  21.6188 |  21.589  |  21.5793 | 939.584  |

Bidirectional Bandwidth Matrix (GB/s): size=32MB
|    |    gpu:0 |    gpu:1 |    gpu:2 |    gpu:3 |    gpu:4 |    gpu:5 |    gpu:6 |    gpu:7 |
|----|----------|----------|----------|----------|----------|----------|----------|----------|
|  0 | 919.804  |  37.1229 |  37.182  |  37.1896 |  37.2953 |  37.2722 |  37.5033 |  37.3752 |
|  1 |  37.44   | 930.087  |  37.2628 |  37.166  |  37.3061 |  37.3485 |  37.1544 |  37.2849 |
|  2 |  37.3691 |  36.9518 | 928.491  |  37.1216 |  37.435  |  37.3376 |  37.2898 |  37.3745 |
|  3 |  37.0629 |  37.0746 |  37.0792 | 930.138  |  37.2742 |  37.3625 |  37.342  |  37.3589 |
|  4 |  37.4967 |  37.3467 |  37.3797 |  37.2799 | 929.04   |  37.7169 |  37.605  |  37.4756 |
|  5 |  37.6528 |  37.3789 |  37.3696 |  37.3652 |  37.4151 | 928.491  |  37.5001 |  37.6067 |
|  6 |  37.4934 |  37.4773 |  37.3424 |  37.2661 |  37.7088 |  37.4144 | 928.491  |  37.3428 |
|  7 |  37.6927 |  37.4543 |  37.4454 |  37.2328 |  37.639  |  37.7096 |  37.3995 | 930.138  |

Latency Matrix (us): size=32MB
|    |   gpu:0 |    gpu:1 |   gpu:2 |    gpu:3 |   gpu:4 |    gpu:5 |    gpu:6 |   gpu:7 |
|----|---------|----------|---------|----------|---------|----------|----------|---------|
|  0 |  2.048  | 11.52    | 20.736  | 17.664   | 19.3493 | 16.3307  | 11.5307  | 13.6107 |
|  1 | 21.4293 |  2.38933 | 10.7413 | 18.2293  | 11.808  | 17.7173  | 22.8267  | 12.832  |
|  2 | 12.384  | 19.2533  |  2.048  | 21.0347  | 11.7013 | 22.4107  | 12.8     | 22.496  |
|  3 | 13.1307 | 20.0533  | 10.7733 |  2.31467 | 15.9893 | 15.232   | 11.4453  | 22.144  |
|  4 | 16.0107 | 21.472   | 12.1493 | 20.448   |  1.728  | 21.4187  | 17.5573  | 12.704  |
|  5 | 11.7973 | 16       | 20.7787 | 12.1707  | 10.3893 |  1.70667 | 11.1787  | 11.1787 |
|  6 | 15.3493 | 20.7787  | 11.136  | 20.7787  | 10.4    | 19.2747  |  1.94133 | 10.4    |
|  7 | 12.48   | 22.0693  | 22.0267 | 12.832   | 11.4133 | 17.216   | 11.7547  |  1.984  |

### NCCL

用于测试集群nccl集合通信带宽。测试结果示例如下：

Results: (GB/s)
|   ALL_REDUCE-1024MB |   ALL_GATHER-1024MB |   ALL_TO_ALL-1024MB |
|---------------------|---------------------|---------------------|
|             15.8604 |             17.3631 |             14.9066 |

### GPFS

用于测试高性能共享存储的读写性能，测试采用`torch.save()`和`torch.load()`算子同步读写共享存储路径下文件到GPU。测试结果示例如下：

Results: (GB/s)
|   write-128MB |   read-128MB |   write-512MB |   read-512MB |   write-1024MB |   read-1024MB |
|---------------|--------------|---------------|--------------|----------------|---------------|
|       2.12521 |      1.84612 |       1.95402 |      1.75663 |          2.296 |       2.06872 |


### nccl_bad_nodes.sh

用于快速排查系统通信慢节点，测试采用相邻节点两两组合，然后换一侧继续两两组合，结合两次结果对比定位慢节点位置。测试结果示例如下：

Results: (GB/s)
|    |   ALLREDUCE-1 |   ALLREDUCE-2 |
|----|---------------|---------------|
|  0 |         25.85 |         26.81 |
|  1 |         25.86 |         18.92 |
|  2 |         18.95 |         18.92 |
|  3 |         18.95 |         26.82 |

待解决问题：

- 1. 如果存在坏节点，暂时无法处理。

- 2. 语法目前只在NVIDIA上跑通，已知METAX卡暂时不支持相关接口。

## 常见问题

- 1. timeout机制不生效：基础测试可能由于系统问题或者用例引入死锁导致hang住，理论上需要引入timeout机制，但是当前设计的`sys_eval/utils/timer.py`在少数情况下无法起作用，尚未排查原因。
